name: Funding Refresh

on:
  schedule:
    # Run at 00:00 on Monday
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate Data Schema
        run: node scripts/validateData.js

      - name: Update Timestamp & Recalculate
        run: |
          node -e "
            const fs = require('fs');
            const path = 'data/funding.json';
            const data = JSON.parse(fs.readFileSync(path, 'utf8'));
            
            // 1. Update Timestamp
            data.lastUpdatedISO = new Date().toISOString();
            
            // 2. Validate/Clamp percents (Optional derivation logic)
            if(data.buckets) {
                data.buckets.forEach(b => {
                    const pct = Math.round((b.raisedUSD / b.goalUSD) * 100);
                    // Ensure raisedUSD isn't weirdly negative or anything
                    if(b.raisedUSD < 0) b.raisedUSD = 0;
                });
            }

            fs.writeFileSync(path, JSON.stringify(data, null, 2));
            console.log('Updated funding.json');
          "

      - name: Commit Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check if there are changes
          if [[ -n $(git status -s) ]]; then
            git add data/funding.json
            git commit -m "chore(data): refresh funding stats"
            git push
          else
            console.log("No changes to commit.");
          fi
